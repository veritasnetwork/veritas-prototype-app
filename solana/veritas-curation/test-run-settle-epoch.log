Starting fresh test validator...
Waiting for validator to be ready...
Waiting for fees to stabilize 1...
Waiting for fees to stabilize 2...
Waiting for fees to stabilize 3...
Running tests with fresh validator...
   Compiling veritas-curation v0.1.0 (/Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/programs/veritas-curation)
warning: unexpected `cfg` condition value: `custom-heap`
  --> programs/veritas-curation/src/lib.rs:24:1
   |
24 | #[program]
   | ^^^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `custom-heap` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: `#[warn(unexpected_cfgs)]` on by default
   = note: this warning originates in the macro `$crate::custom_heap_default` which comes from the expansion of the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `custom-panic`
  --> programs/veritas-curation/src/lib.rs:24:1
   |
24 | #[program]
   | ^^^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `custom-panic` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the macro `$crate::custom_panic_default` which comes from the expansion of the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/content_pool/instructions/deploy_market.rs:31:10
   |
31 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unused import: `mul_div_u128`
  --> programs/veritas-curation/src/content_pool/instructions/trade.rs:12:12
   |
12 |     math::{mul_div_u128, round_to_nearest, renormalize_scales, ceil_div},
   |            ^^^^^^^^^^^^
   |
   = note: `#[warn(unused_imports)]` on by default

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/veritas-curation/src/content_pool/instructions/trade.rs:142:10
    |
142 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/content_pool/instructions/add_liquidity.rs:11:10
   |
11 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/content_pool/instructions/settle_epoch.rs:12:10
   |
12 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/content_pool/instructions/close_pool.rs:10:10
   |
10 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/content_pool/instructions/get_current_state.rs:10:10
   |
10 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unused import: `Q64`
 --> programs/veritas-curation/src/content_pool/curve.rs:3:31
  |
3 | use super::state::{TokenSide, Q64};
  |                               ^^^

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/veritas-curation/src/pool_factory/instructions/initialize_factory.rs:109:10
    |
109 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
   --> programs/veritas-curation/src/pool_factory/instructions/create_pool.rs:121:10
    |
121 | #[derive(Accounts)]
    |          ^^^^^^^^
    |
    = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
    = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
    = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
    = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/pool_factory/instructions/update_protocol_authority.rs:62:10
   |
62 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/pool_factory/instructions/update_defaults.rs:98:10
   |
98 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/pool_factory/instructions/update_fee_config.rs:68:10
   |
68 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/veritas_custodian/instructions/initialize_custodian.rs:32:10
   |
32 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/veritas_custodian/instructions/deposit.rs:47:10
   |
47 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/veritas_custodian/instructions/withdraw.rs:70:10
   |
70 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/veritas_custodian/instructions/update_protocol_authority.rs:47:10
   |
47 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/veritas_custodian/instructions/toggle_emergency_pause.rs:42:10
   |
42 | #[derive(Accounts)]
   |          ^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/lib.rs:24:1
   |
24 | #[program]
   | ^^^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unexpected `cfg` condition value: `anchor-debug`
  --> programs/veritas-curation/src/lib.rs:24:1
   |
24 | #[program]
   | ^^^^^^^^^^
   |
   = note: expected values for `feature` are: `cpi`, `default`, `idl-build`, `no-entrypoint`, `no-idl`, and `no-log-ix-name`
   = help: consider adding `anchor-debug` as a feature in `Cargo.toml`
   = note: see <https://doc.rust-lang.org/nightly/rustc/check-cfg/cargo-specifics.html> for more information about checking conditional configuration
   = note: this warning originates in the derive macro `Accounts` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: use of deprecated method `anchor_lang::prelude::AccountInfo::<'a>::realloc`: Use AccountInfo::resize() instead
  --> programs/veritas-curation/src/lib.rs:24:1
   |
24 | #[program]
   | ^^^^^^^^^^
   |
   = note: `#[warn(deprecated)]` on by default
   = note: this warning originates in the attribute macro `program` (in Nightly builds, run with -Z macro-backtrace for more info)

warning: unused variable: `pool_key`
   --> programs/veritas-curation/src/content_pool/instructions/trade.rs:217:9
    |
217 |     let pool_key = pool.key();
    |         ^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_pool_key`
    |
    = note: `#[warn(unused_variables)]` on by default

warning: unused variable: `current_time`
   --> programs/veritas-curation/src/content_pool/instructions/trade.rs:219:9
    |
219 |     let current_time = clock.unix_timestamp;
    |         ^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_current_time`

warning: unused variable: `current_time`
  --> programs/veritas-curation/src/content_pool/instructions/get_current_state.rs:18:9
   |
18 |     let current_time = Clock::get()?.unix_timestamp;
   |         ^^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_current_time`

warning: `veritas-curation` (lib) generated 31 warnings (5 duplicates) (run `cargo fix --lib -p veritas-curation` to apply 2 suggestions)
    Finished `release` profile [optimized] target(s) in 5.59s
   Compiling veritas-curation v0.1.0 (/Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/programs/veritas-curation)
    Finished `test` profile [unoptimized + debuginfo] target(s) in 3.74s
     Running unittests src/lib.rs (/Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/target/debug/deps/veritas_curation-ed4d90d9a979a137)
Deploying cluster: http://127.0.0.1:8899
Upgrade authority: /Users/josh/.config/solana/id.json
Deploying program "veritas_curation"...
Program path: /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/target/deploy/veritas_curation.so...
Program Id: D1tNYkzevBrxRM9XNALUVAHU4Lg7W7YQkK8eFTxuMhRC

Signature: 5J79AZszNmSyu66JvmLyHM1feEEz8zkDA6a9CyFKRh7gnMT4qpKsuZZ9VKbBEBgVNdfmtoEDHFJL9hBNbizqAxmA

Deploy success

Found a 'test' script in the Anchor.toml. Running it as a test suite!

Running test suite: "/Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/Anchor.toml"

yarn run v1.22.19
warning ../../../../package.json: No license field
$ /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/node_modules/.bin/ts-mocha -p ./tsconfig.json -t 1000000 tests/content-pool-icbs.test.ts tests/pool-factory-icbs.test.ts tests/fee-calculation.test.ts tests/fee-config.test.ts tests/trade-fees.test.ts tests/upgrade-authority-prototype.test.ts tests/debug-lambda-calc.test.ts
(node:91865) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  ContentPool ICBS Tests
‚úÖ Using test authority (PROTOCOL_AUTHORITY_KEYPAIR not set): 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
    1. Pool Initialization
      1.1 Empty Pool Creation
        ‚úî creates empty pool with factory reference (473ms)
      1.2 Parameter Validation
        ‚úî validates F parameter bounds (1-10)
        ‚úî validates beta coefficient bounds (0.1-0.9) (459ms)
    2. Market Deployment
      2.1 First Trader Deployment
On-manifold deployment results:
  LONG allocation: 60000000
  SHORT allocation: 40000000
  Actual LONG tokens: 60000000
  Actual SHORT tokens: 49000000
  Pool s_long: 60
  Pool s_short: 49
  Œª (derived, Q96): 102893716522055470715455291429299346
  ||s||: 77
  C(s) = Œª¬∑||s||: 99999998
  Initial deposit: 100000000
  Difference: 2
  r_long: 59990001
  r_short: 40009998
  r_long + r_short: 99999999
  Vault balance: 99999999
  Reserve sum - vault: 0
  sqrt_price_long (Q96): 79221560992566900799498415505408
  Price LONG: 999833
  Factory p0: 1000000
  Price difference: 167
        ‚úî allows first trader to deploy market with initial liquidity (478ms)
        ‚úî enforces minimum initial deposit ($100) (483ms)
        1) prevents duplicate market deployment
    3. ICBS Mathematics
      3.1 Cost Function Calculation
        2) calculates cost function C(s_L, s_S) correctly
        ‚úî calculates marginal prices correctly
      3.2 Virtual Reserves
        3) maintains virtual reserves as R = s √ó p
        ‚úî calculates market prediction q correctly (932ms)
      3.3 Inverse Coupling
        4) demonstrates inverse coupling on LONG buy
        ‚úî demonstrates inverse coupling on SHORT buy (464ms)
        ‚úî maintains price √ó supply = reserve invariant
    4. Trading Operations
      4.1 Buy Operations
        ‚úî executes LONG buy with correct token output (966ms)
        5) applies stake skim on buys
        ‚úî enforces slippage protection on buys
      4.2 Sell Operations
        ‚úî executes LONG sell with correct USDC output (1015ms)
        ‚úî executes SHORT sell with correct USDC output (924ms)
        6) enforces slippage protection on sells
        ‚úî applies zero skim on sells (929ms)
        7) prevents selling more tokens than owned
        ‚úî handles partial position exit (1385ms)
        ‚úî auto-creates ATA on buy and uses it on sell (2840ms)
      4.3 Trade Size Limits
        8) enforces minimum trade size
      4.4 SPL Token Operations
        ‚úî allows token transfers between wallets (922ms)
        ‚úî allows users to burn tokens directly (482ms)
    5. Settlement Mechanics
      5.1 BD Score Settlement
        9) settles with BD score updating reserves
        10) enforces settlement cooldown
        ‚úî validates BD score bounds (449ms)
      5.3 Authority Validation
        11) requires protocol authority for settlement
    7. State Invariants
      7.1 Supply and Reserve Consistency
        12) maintains token supply consistency across operations
        13) maintains R = C(s) relationship
      7.2 Settlement Invariants
        14) maintains zero-sum property in settlement
        15) clamps q to prevent division issues
    close_pool
      16) should close pool after all positions are burned
      17) should fail to close pool with open positions
      18) should fail to close pool without protocol authority
    9. Edge Cases
      9.1 Numerical Stability
        ‚úî handles very small trades correctly (389ms)
        19) handles settlement with extreme BD scores
        - preserves reserve invariants through multiple settlements
        20) maintains precision in X96 sqrt price calculations
        ‚úî handles buy-then-sell round-trip correctly (919ms)
    9.2 Time-Based Decay
      21) applies decay after expiration for tier 1 (1% per day)

=== Decay Calculation - Tier 2 ===
Initial q: 0.6
Days expired: 10
Decay rate: 200 bps per day
Total decay: 2000 bps
Expected q after decay: 0.4
      ‚úî calculates correct decay for tier 2 (2% per day)

=== Decay Clamping Test ===
Initial q: 0.3
Days expired: 100
Total decay would be: 30000 bps (300%)
Clamped q after decay: 0.1
      ‚úî clamps decay to minimum q (10%)

=== Decay Tier 3 Test ===
Initial q: 0.8
Days expired: 35 (tier 3)
Decay rate: 300 bps per day
Expected q after decay: 0.1 (clamped)
      ‚úî uses tier 3 decay rate (3% per day) after 30 days

=== Decay Before Expiration ===
Current time: 1000000
Expiration time: 2000000
Should apply decay: false
      ‚úî does not apply decay before expiration

=== Reserve Invariants After Decay ===
R_total before: 100000000
R_total after: 100000000
q before: 0.6000
q after: 0.5900
      ‚úî preserves reserve invariants after decay
    10. Event Emission
      22) emits TradeExecuted event on buy
      23) emits TradeExecuted event on sell
      24) emits PoolSettled event on settlement

  PoolFactory ICBS Tests
‚úÖ Using test authority (PROTOCOL_AUTHORITY_KEYPAIR not set): 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
    1. Factory Initialization
      1.1 Singleton Creation
        25) initializes factory with correct authorities
        ‚úî prevents duplicate factory initialization
      1.2 Default Parameters
        26) sets correct default ICBS parameters
    2. Pool Creation
      2.1 Permissionless Creation
        ‚úî allows any user to create a pool with protocol validation (388ms)
        ‚úî allows permissionless pool creation (468ms)
      2.2 Registry Management
        ‚úî creates registry entry for each pool (461ms)
        ‚úî prevents duplicate pools for same content_id (489ms)
      2.3 Parameter Inheritance
        ‚úî creates pool with factory default parameters (445ms)
        ‚úî inherits factory defaults (no custom parameters) (481ms)
    3. Authority Management
      3.1 Pool Authority Updates
        ‚úî allows factory_authority to update pool_authority (936ms)
        ‚úî rejects pool_authority update from unauthorized signer
        ‚úî rejects pool_authority update from protocol_authority itself
        ‚úî validates new pool_authority is not default pubkey
      3.2 Factory Authority Transfer
        - allows factory_authority to transfer ownership
    4. Default Parameter Updates
      4.1 Update Default ICBS Parameters
        ‚úî allows factory_authority to update default_f (1372ms)
        ‚úî allows factory_authority to update default_beta (972ms)
        ‚úî validates parameter bounds on update
        ‚úî allows update of min_initial_deposit (934ms)
        ‚úî allows update of min_settle_interval (946ms)
        ‚úî rejects updates from non-factory-authority
        ‚úî existing pools retain original parameters after default update (1875ms)
    5. State Consistency
      5.1 Pool Counter
        ‚úî increments total_pools atomically (482ms)
      5.2 PDA Derivation
        ‚úî derives consistent PDAs for factory
        ‚úî derives consistent PDAs for registries (464ms)
    7. Error Handling
      7.1 Input Validation
        ‚úî rejects invalid content_id (default pubkey) (487ms)
    8. Event Emission
      ‚úî emits PoolCreated event on pool creation (567ms)
      ‚úî emits DefaultsUpdated event on parameter change (842ms)

  Fee Calculation Tests
    Standard Fee Scenarios
      ‚úî calculates 0.5% fee (50 bps) correctly
      ‚úî calculates 1% fee (100 bps) correctly
      ‚úî calculates 10% fee (1000 bps) correctly
    Fee Split Scenarios
      ‚úî splits 100% to creator (10000 bps)
      ‚úî splits 50/50 (5000 bps)
      ‚úî splits 70/30 (7000 bps)
      ‚úî splits 0% to creator (0 bps) - all to protocol
    Edge Cases
      ‚úî handles zero fee (0 bps)
      ‚úî handles 100% fee (10000 bps)
      ‚úî handles rounding down for small amounts
      ‚úî handles rounding on fee split
    Large Amount Tests
      ‚úî handles 1M USDC trade
      ‚úî handles max trade size with high fee
    Invariants
      ‚úî ensures creator_fee + protocol_fee = total_fee
      ‚úî ensures total_fee <= amount
      ‚úî ensures creator_fee <= total_fee

  Fee Configuration Tests
    1. Authority Validation
  ‚ö†Ô∏è Test pending: upgrade authority pattern not yet implemented
  Expected: Upgrade authority can call update_fee_config
      ‚úî allows upgrade authority to update fee config
  ‚ö†Ô∏è Test pending: upgrade authority pattern not yet implemented
  Expected: Non-authority cannot call update_fee_config
      ‚úî rejects non-upgrade authority
  ‚ö†Ô∏è Test pending: upgrade authority pattern not yet implemented
  Expected: Fails with InvalidUpgradeAuthority if program is immutable
      ‚úî rejects if no upgrade authority set (immutable program)
    2. Fee Updates
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: total_fee_bps updates from 50 ‚Üí 100
      ‚úî updates total_fee_bps
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: creator_split_bps updates from 10000 ‚Üí 7000
      ‚úî updates creator_split_bps
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: protocol_treasury address changes
      ‚úî updates protocol_treasury
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: All specified fields update in one transaction
      ‚úî updates multiple fields atomically
    3. Validation Rules
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Fails with InvalidCreatorSplit for split > 10000
      ‚úî rejects creator_split_bps > 10000
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Allows 0 fee (free trading)
      ‚úî accepts total_fee_bps = 0 (free trades)
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Allows 100% fee (though not recommended)
      ‚úî accepts total_fee_bps = 10000 (100% fee)
    4. Event Emission
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Event contains updated config and timestamp
      ‚úî emits FeeConfigUpdatedEvent
    5. Authority Transfer Scenarios
  ‚ö†Ô∏è Test pending: requires solana program set-upgrade-authority
  Expected:
    1. Transfer authority via CLI
    2. New authority can immediately update fee config
    3. Old authority can no longer update fee config
      ‚úî respects new authority after transfer
    6. Edge Cases
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Updates only total_fee_bps, leaves other fields unchanged
      ‚úî handles partial updates (only total_fee_bps)
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Updates only creator_split_bps, leaves other fields unchanged
      ‚úî handles partial updates (only creator_split_bps)
  ‚ö†Ô∏è Test pending: update_fee_config instruction not yet implemented
  Expected: Updates only protocol_treasury, leaves other fields unchanged
      ‚úî handles partial updates (only protocol_treasury)

  Trade Fees Integration Tests
    Setup
  ‚ö†Ô∏è Test pending: create_pool with post_creator not yet implemented
  Expected: Pool stores post_creator address
      ‚úî deploys pool with post_creator
  ‚ö†Ô∏è Test pending: awaiting fee implementation
  Expected:
    - Post creator has USDC ATA
    - Protocol treasury has USDC ATA
    - Trader has USDC ATA with balance
      ‚úî creates USDC accounts for all parties
    BUY Trade Fees
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    1. Trader starts with 100 USDC
    2. Trade 100 USDC with 0.5% fee
    3. Trader sends 0.50 USDC ‚Üí creator
    4. Trader sends 99.50 USDC ‚Üí vault
    5. Vault balance increases by 99.50 only
      ‚úî deducts fees from trader wallet (not vault)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - Creator receives 0.50 USDC
    - Protocol treasury receives 0 USDC
      ‚úî splits fees correctly (100% creator)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - Creator receives 0.35 USDC (70%)
    - Protocol treasury receives 0.15 USDC (30%)
      ‚úî splits fees correctly (70/30 split)
  ‚ö†Ô∏è Test pending: TradeFeeEvent not yet implemented
  Expected: Event contains total_fee, creator_fee, protocol_fee
      ‚úî emits TradeFeeEvent with correct amounts
    SELL Trade Fees
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    1. Trader burns tokens
    2. ICBS calculates proceeds = 100 USDC
    3. Vault sends 0.50 USDC ‚Üí creator
    4. Vault sends 99.50 USDC ‚Üí trader
    5. Vault balance decreases by 100 total
      ‚úî deducts fees from vault (after burn)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected: Pool PDA signs transfers from vault ‚Üí creator/treasury
      ‚úî uses pool PDA to sign fee transfers
  ‚ö†Ô∏è Test pending: TradeFeeEvent not yet implemented
  Expected: Event contains total_fee, creator_fee, protocol_fee
      ‚úî emits TradeFeeEvent with correct amounts
    Edge Cases
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected: Trade fails with clear error about missing ATA
      ‚úî handles creator with no USDC ATA (should fail gracefully)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - No fee transfers attempted
    - Full amount goes to vault (BUY) or trader (SELL)
    - Event emitted with 0 fees
      ‚úî handles zero fee configuration
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - All USDC goes to fees
    - Net trade amount = 0
    - Trade likely fails due to MIN_TRADE_SIZE check
      ‚úî handles 100% fee configuration
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - Trade 0.10 USDC with 0.5% fee
    - Fee = 0.0005 USDC = 500 micro-USDC
    - Rounds down to 0 if < 1 micro-USDC
      ‚úî handles very small trades (rounding edge case)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - Trade 1M USDC with 5% fee
    - Fee = 50K USDC
    - No overflow in checked_mul operations
      ‚úî handles very large trades (overflow protection)
    Vault Accounting
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - vault_balance_before + net_trade_amount = vault_balance_after
    - Does NOT include fees in vault balance
      ‚úî maintains vault balance invariant (BUY)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - vault_balance_before - usdc_proceeds = vault_balance_after
    - usdc_proceeds includes fees + trader payout
      ‚úî maintains vault balance invariant (SELL)
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected: pool.vault_balance == actual vault token account balance
      ‚úî vault balance matches actual token account
    Concurrency Tests
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - All trades succeed
    - All fees collected correctly
    - No race conditions
    - Vault balance consistent
      ‚úî handles 10 concurrent BUY trades
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - All trades succeed
    - All fees collected correctly
    - No race conditions
    - Vault balance consistent
      ‚úî handles 10 concurrent SELL trades
  ‚ö†Ô∏è Test pending: fee logic in trade instruction not yet implemented
  Expected:
    - Interleaved BUY and SELL trades
    - Fee calculations remain consistent
    - Vault balance never goes negative
      ‚úî handles mixed BUY/SELL trades
    End-to-End Scenario
  ‚ö†Ô∏è Test pending: full refactor not yet implemented
  Scenario:
    1. User A creates post ‚Üí becomes post_creator
    2. User B deploys pool for post
    3. User C buys 100 USDC of LONG tokens
    4. User A receives 0.50 USDC fee
    5. Pool vault has 99.50 USDC
    6. User C sells half their tokens
    7. User A receives additional fee from sell
    8. Vault balance remains consistent
      ‚úî full lifecycle with fees

  Upgrade Authority Prototype
Program ID: D1tNYkzevBrxRM9XNALUVAHU4Lg7W7YQkK8eFTxuMhRC
Program Data Address: 2CX6yDGXqpxMBLGM2r6cx6Xwdc4NsyJSPLGfn5kyEKwZ
    1. Query Upgrade Authority from Chain
‚úì Program data account exists
  Owner: BPFLoaderUpgradeab1e11111111111111111111111
  Data length: 730885
      ‚úî retrieves program data account
  Deployment slot: 64
  Has upgrade authority: true
  Upgrade authority: 5Kp53XUxEUeBAGjbwgR8byf5SGhW82L6S1NWtzYrzwqe
      ‚úî deserializes upgrade authority from program data
    2. Validate Authority in Instruction
  Signer: 5Kp53XUxEUeBAGjbwgR8byf5SGhW82L6S1NWtzYrzwqe
  Current authority: 5Kp53XUxEUeBAGjbwgR8byf5SGhW82L6S1NWtzYrzwqe
  Authorized: true
      ‚úî accepts valid upgrade authority
  ‚úì Correctly rejected unauthorized signer
      ‚úî rejects invalid upgrade authority
    3. Authority Transfer Simulation

  üìù Authority Transfer Flow:
  1. Current authority signs transfer
  2. New authority is set via: solana program set-upgrade-authority
  3. Program data account is updated on-chain
  4. New authority can immediately call governance functions
  5. Old authority can no longer call governance functions

  ‚ö†Ô∏è Actual transfer requires CLI command or program upgrade instruction
  This test only validates the pattern works for reading current authority
      ‚úî simulates authority transfer
    4. Anchor Integration Pattern

  üìö Implementation Pattern:

  // In instruction context:
  #[derive(Accounts)]
  pub struct GovernanceInstruction<'info> {
      pub upgrade_authority: Signer<'info>,

      #[account(constraint = program.programdata_address()? == Some(program_data.key()))]
      pub program: Program<'info, YourProgram>,

      /// CHECK: Program data account
      pub program_data: AccountInfo<'info>,
  }

  // In handler:
  let program_data = ctx.accounts.program_data.try_borrow_data()?;

  let upgrade_authority_address = match UpgradeableLoaderState::try_from_slice(&program_data)? {
      UpgradeableLoaderState::ProgramData {
          slot: _,
          upgrade_authority_address
      } => upgrade_authority_address,
      _ => return Err(ErrorCode::InvalidProgramData.into()),
  };

  require!(
      upgrade_authority_address == Some(*ctx.accounts.upgrade_authority.key()),
      ErrorCode::InvalidUpgradeAuthority
  );
      
  ‚úì Pattern documented for implementation
      ‚úî documents the pattern for Anchor programs
    5. Security Considerations

  üîí Security Notes:
  ‚Ä¢ Always validate program_data.key() matches program.programdata_address()
  ‚Ä¢ Check discriminator == 3 (ProgramData)
  ‚Ä¢ Handle None case (immutable program)
  ‚Ä¢ Use require! for authority validation, not assert!
  ‚Ä¢ Ensure proper error codes are returned
  ‚Ä¢ Test with actual authority transfer on devnet before mainnet
      ‚úî lists security considerations

  debug-lambda-calc
Input values:
  D (initial_deposit): 50000000
  s_l: 116
  s_s: 24
  n^2: 14032

    27) calculates lambda correctly


  109 passing (50s)
  2 pending
  27 failing

  1) ContentPool ICBS Tests
       2. Market Deployment
         2.1 First Trader Deployment
           prevents duplicate market deployment:
     ReferenceError: longMint is not defined
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:670:73
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) ContentPool ICBS Tests
       3. ICBS Mathematics
         3.1 Cost Function Calculation
           calculates cost function C(s_L, s_S) correctly:
     AssertionError: R_total should equal total funds (vault + stake): expected 119910000, got 117909999, diff 2000001 micro-USDC: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:807:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) ContentPool ICBS Tests
       3. ICBS Mathematics
         3.2 Virtual Reserves
           maintains virtual reserves as R = s √ó p:
     AssertionError: R_total = total funds: 140297499 vs 144797500: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:928:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) ContentPool ICBS Tests
       3. ICBS Mathematics
         3.3 Inverse Coupling
           demonstrates inverse coupling on LONG buy:
     TypeError: Cannot convert a BigInt value to a number
      at Math.pow (<anonymous>)
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:1092:21
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  5) ContentPool ICBS Tests
       4. Trading Operations
         4.1 Buy Operations
           applies stake skim on buys:

      AssertionError: expected '89550000' to equal '90000000'
      + expected - actual

      -89550000
      +90000000
      
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:1428:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  6) ContentPool ICBS Tests
       4. Trading Operations
         4.2 Sell Operations
           enforces slippage protection on sells:
     AssertionError: Should fail with slippage error: expected 'AnchorError caused by account: protoc‚Ä¶' to include '6012'
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:1792:18
      at Generator.throw (<anonymous>)
      at rejected (tests/content-pool-icbs.test.ts:39:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  7) ContentPool ICBS Tests
       4. Trading Operations
         4.2 Sell Operations
           prevents selling more tokens than owned:
     AssertionError: Should fail with SPL token error: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:1946:18
      at Generator.throw (<anonymous>)
      at rejected (tests/content-pool-icbs.test.ts:39:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  8) ContentPool ICBS Tests
       4. Trading Operations
         4.3 Trade Size Limits
           enforces minimum trade size:
     AssertionError: expected 'AnchorError caused by account: protoc‚Ä¶' to include '6007'
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:2235:18
      at Generator.throw (<anonymous>)
      at rejected (tests/content-pool-icbs.test.ts:39:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  9) ContentPool ICBS Tests
       5. Settlement Mechanics
         5.1 BD Score Settlement
           settles with BD score updating reserves:
     Error: Account `vault` not provided.
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/node_modules/@coral-xyz/anchor/src/program/common.ts:51:15
      at Array.forEach (<anonymous>)
      at validateAccounts (node_modules/@coral-xyz/anchor/src/program/common.ts:46:14)
      at ix (node_modules/@coral-xyz/anchor/src/program/namespace/instruction.ts:44:23)
      at txFn (node_modules/@coral-xyz/anchor/src/program/namespace/transaction.ts:24:14)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:21:18)
      at MethodsBuilder.rpc (node_modules/@coral-xyz/anchor/src/program/namespace/methods.ts:434:17)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  10) ContentPool ICBS Tests
       5. Settlement Mechanics
         5.1 BD Score Settlement
           enforces settlement cooldown:
     AssertionError: Expected SettlementCooldown error, got: Error: Account `vault` not provided.: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:2524:18
      at Generator.throw (<anonymous>)
      at rejected (tests/content-pool-icbs.test.ts:39:65)

  11) ContentPool ICBS Tests
       5. Settlement Mechanics
         5.3 Authority Validation
           requires protocol authority for settlement:
     AssertionError: Expected constraint/authorization error, got: Error: Account `vault` not provided.: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:2620:18
      at Generator.throw (<anonymous>)
      at rejected (tests/content-pool-icbs.test.ts:39:65)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  12) ContentPool ICBS Tests
       7. State Invariants
         7.1 Supply and Reserve Consistency
           maintains token supply consistency across operations:

      Pool s_long should match LONG mint total supply
      + expected - actual

      -81
      +70875000
      
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:2668:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  13) ContentPool ICBS Tests
       7. State Invariants
         7.1 Supply and Reserve Consistency
           maintains R = C(s) relationship:
     Error: AnchorError caused by account: protocol_authority. Error Code: UnauthorizedProtocol. Error Number: 6026. Error Message: Unauthorized protocol authority.
      at AnchorError.parse (node_modules/@coral-xyz/anchor/src/error.ts:168:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  14) ContentPool ICBS Tests
       7. State Invariants
         7.2 Settlement Invariants
           maintains zero-sum property in settlement:
     Error: unknown signer: 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
      at Transaction._addSignature (node_modules/@solana/web3.js/src/transaction/legacy.ts:754:13)
      at forEach (node_modules/@solana/web3.js/src/transaction/legacy.ts:727:12)
      at Array.forEach (<anonymous>)
      at Transaction._partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:725:13)
      at Transaction.partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:717:10)
      at AnchorProvider.sendAndConfirm (node_modules/@coral-xyz/anchor/src/provider.ts:159:14)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:29:16)

  15) ContentPool ICBS Tests
       7. State Invariants
         7.2 Settlement Invariants
           clamps q to prevent division issues:
     Error: unknown signer: 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
      at Transaction._addSignature (node_modules/@solana/web3.js/src/transaction/legacy.ts:754:13)
      at forEach (node_modules/@solana/web3.js/src/transaction/legacy.ts:727:12)
      at Array.forEach (<anonymous>)
      at Transaction._partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:725:13)
      at Transaction.partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:717:10)
      at AnchorProvider.sendAndConfirm (node_modules/@coral-xyz/anchor/src/provider.ts:159:14)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:29:16)

  16) ContentPool ICBS Tests
       close_pool
         should close pool after all positions are burned:
     Error: unknown signer: 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
      at Transaction._addSignature (node_modules/@solana/web3.js/src/transaction/legacy.ts:754:13)
      at forEach (node_modules/@solana/web3.js/src/transaction/legacy.ts:727:12)
      at Array.forEach (<anonymous>)
      at Transaction._partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:725:13)
      at Transaction.partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:717:10)
      at AnchorProvider.sendAndConfirm (node_modules/@coral-xyz/anchor/src/provider.ts:159:14)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:29:16)

  17) ContentPool ICBS Tests
       close_pool
         should fail to close pool with open positions:
     Error: unknown signer: 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
      at Transaction._addSignature (node_modules/@solana/web3.js/src/transaction/legacy.ts:754:13)
      at forEach (node_modules/@solana/web3.js/src/transaction/legacy.ts:727:12)
      at Array.forEach (<anonymous>)
      at Transaction._partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:725:13)
      at Transaction.partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:717:10)
      at AnchorProvider.sendAndConfirm (node_modules/@coral-xyz/anchor/src/provider.ts:159:14)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:29:16)

  18) ContentPool ICBS Tests
       close_pool
         should fail to close pool without protocol authority:
     Error: unknown signer: 2pKJS62zuSwyRFN1Snf3ZqDnrZD2oh5X5EgdACfUhKCp
      at Transaction._addSignature (node_modules/@solana/web3.js/src/transaction/legacy.ts:754:13)
      at forEach (node_modules/@solana/web3.js/src/transaction/legacy.ts:727:12)
      at Array.forEach (<anonymous>)
      at Transaction._partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:725:13)
      at Transaction.partialSign (node_modules/@solana/web3.js/src/transaction/legacy.ts:717:10)
      at AnchorProvider.sendAndConfirm (node_modules/@coral-xyz/anchor/src/provider.ts:159:14)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:29:16)

  19) ContentPool ICBS Tests
       9. Edge Cases
         9.1 Numerical Stability
           handles settlement with extreme BD scores:
     Error: Account `vault` not provided.
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/node_modules/@coral-xyz/anchor/src/program/common.ts:51:15
      at Array.forEach (<anonymous>)
      at validateAccounts (node_modules/@coral-xyz/anchor/src/program/common.ts:46:14)
      at ix (node_modules/@coral-xyz/anchor/src/program/namespace/instruction.ts:44:23)
      at txFn (node_modules/@coral-xyz/anchor/src/program/namespace/transaction.ts:24:14)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:21:18)
      at MethodsBuilder.rpc (node_modules/@coral-xyz/anchor/src/program/namespace/methods.ts:434:17)

  20) ContentPool ICBS Tests
       9. Edge Cases
         9.1 Numerical Stability
           maintains precision in X96 sqrt price calculations:
     AssertionError: s_scale_long should be reasonable: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:3697:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  21) ContentPool ICBS Tests
       9.2 Time-Based Decay
         applies decay after expiration for tier 1 (1% per day):
     Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 1: custom program error: 0x1. 
Logs: 
[
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA success",
  "Program ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL consumed 21889 of 1110364 compute units",
  "Program ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL success",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [2]",
  "Program log: Instruction: Transfer",
  "Program log: Error: insufficient funds",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA consumed 4300 of 1086224 compute units",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA failed: custom program error: 0x1",
  "Program D1tNYkzevBrxRM9XNALUVAHU4Lg7W7YQkK8eFTxuMhRC consumed 117926 of 1199850 compute units",
  "Program D1tNYkzevBrxRM9XNALUVAHU4Lg7W7YQkK8eFTxuMhRC failed: custom program error: 0x1"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
  

  22) ContentPool ICBS Tests
       10. Event Emission
         emits TradeExecuted event on buy:
     AssertionError: Transaction logs should contain trade event: expected false to be truthy
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/content-pool-icbs.test.ts:4218:14
      at Generator.next (<anonymous>)
      at fulfilled (tests/content-pool-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  23) ContentPool ICBS Tests
       10. Event Emission
         emits TradeExecuted event on sell:
     Error: AnchorError thrown in programs/veritas-curation/src/content_pool/instructions/trade.rs:594. Error Code: InvalidTradeAmount. Error Number: 6012. Error Message: Invalid trade amount.
      at AnchorError.parse (node_modules/@coral-xyz/anchor/src/error.ts:152:14)
      at translateError (node_modules/@coral-xyz/anchor/src/error.ts:277:35)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:35:29)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  24) ContentPool ICBS Tests
       10. Event Emission
         emits PoolSettled event on settlement:
     Error: Account `vault` not provided.
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/node_modules/@coral-xyz/anchor/src/program/common.ts:51:15
      at Array.forEach (<anonymous>)
      at validateAccounts (node_modules/@coral-xyz/anchor/src/program/common.ts:46:14)
      at ix (node_modules/@coral-xyz/anchor/src/program/namespace/instruction.ts:44:23)
      at txFn (node_modules/@coral-xyz/anchor/src/program/namespace/transaction.ts:24:14)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:21:18)
      at MethodsBuilder.rpc (node_modules/@coral-xyz/anchor/src/program/namespace/methods.ts:434:17)

  25) PoolFactory ICBS Tests
       1. Factory Initialization
         1.1 Singleton Creation
           initializes factory with correct authorities:

      AssertionError: expected 'EhVfqrC59X799rjnfPKwjW7YRrtiS8hzfmZ22‚Ä¶' to equal 'GJrgci4QzhCfxroLcYe972cdtWEoNpoDNgSoN‚Ä¶'
      + expected - actual

      -EhVfqrC59X799rjnfPKwjW7YRrtiS8hzfmZ22YPpEdoL
      +GJrgci4QzhCfxroLcYe972cdtWEoNpoDNgSoN96BUvdh
      
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/pool-factory-icbs.test.ts:153:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/pool-factory-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  26) PoolFactory ICBS Tests
       1. Factory Initialization
         1.2 Default Parameters
           sets correct default ICBS parameters:

      AssertionError: expected '50000000' to equal '100000000'
      + expected - actual

      -50000000
      +100000000
      
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/pool-factory-icbs.test.ts:205:16
      at Generator.next (<anonymous>)
      at fulfilled (tests/pool-factory-icbs.test.ts:38:58)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)

  27) debug-lambda-calc
       calculates lambda correctly:
     TypeError: Cannot convert a BigInt value to a number
      at Math.pow (<anonymous>)
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/debug-lambda-calc.test.ts:31:17
      at Generator.next (<anonymous>)
      at /Users/josh/veritas/veritas-prototype-app/solana/veritas-curation/tests/debug-lambda-calc.test.ts:46:71
      at new Promise (<anonymous>)
      at __awaiter (tests/debug-lambda-calc.test.ts:42:12)
      at Context.<anonymous> (tests/debug-lambda-calc.test.ts:17:48)
      at processImmediate (node:internal/timers:505:21)



error Command failed with exit code 27.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
Cleaning up validator...
